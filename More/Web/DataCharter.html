<html>
    <head>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <style>
          body {
            background-color: white;
            color: black;
          }
          table {
            width:100%;
            text-align: center; 
            border: 1.5px solid black;
            padding: 4px 1px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
          }
          input[type=file] {
            display: none;
          }
          td {
            border-right:1px solid black;
            border-left:1px solid black;
            border-bottom:1px solid black;
            border-top: 1px solid black;
            width: 25%;
          }
          label{
            font-size: 14px;
            font-family: Arial, Helvetica, sans-serif;
            font-weight: normal;
            margin: 4px;
            border: 1px solid black;
            padding: 8px 14px;
            display: inline-block;
            transition: all 0.5s ease;
            -webkit-transition: all 0.5s ease;
            -moz-transition: all 0.5s ease;
            -ms-transition: all 0.5s ease;
            -o-transition: all 0.5s ease;
          }
          label:hover {
            color:white;
            background-color:black;
          }
          #fileinput {
            display: none;
          }
          div {
            transition: opacity 0.8s ease-in-out;
            -webkit-transition: opacity 0.8s ease-in-out;
            -moz-transition: opacity 0.8s ease-in-out;
            -ms-transition: opacity 0.8s ease-in-out;
            -o-transition: opacity 0.8s ease-in-out;
          }
          .compare {
            width: 91.25%;
            padding: 10px 0px; 
            height: 100%;
          }
        </style>
    </head>
<body>
<div id="chartContainer"></div>
<label id="filelabel">Chart HEG Data</label>
<script>   
      //TODO: Show notes as hover-expanding info points
       var drawChart = function( csvUrl, chartId, updatePlot=false, olddata=[] ) {
         d3.csv( csvUrl, d3.autoType).then(function( rows ) {
            console.log("Data: ", rows);
            //var ctx = document.getElementById(chartId)
            var usMap = rows.map(function(d) {if(d.ms){return (d.ms - rows[0]['ms'])*0.000001*0.01667}else{return (d.us- rows[0]['us'])*0.000001*0.01666}});
            var redMap = rows.map(function(d) {return d.red});
            var irMap = rows.map(function(d) {return d.ir});
            var ratioMap = rows.map(function(d) {return d.ratio}); //console.log("Ratio Map: ",ratioMap);
            var ambientMap = rows.map(function(d) {if(d.ambient){return d.ambient}else{return d.adcAvg}});
            var velMap = rows.map(function(d) {if(d.Vel){return d.Vel}else{return d.ratioSlope}});
            var accelMap = rows.map(function(d) {if(d.Accel){return d.Accel}else if(d.AI){return d.AI}else{return d.vAI}});

            var smaMap = sma(ratioMap, 40); // ~2 second average

            var trace1 = {
                type: 'scatter',
                x: usMap,//usMap,
                y: ratioMap,//ratioMap,
                name: 'Ratio'
            };
            var trace2 = {
                type: 'scatter',
                x: usMap,//usMap,
                y: redMap,//ratioMap,
                name: 'Red',
                visible: 'legendonly',
                line: {
                  color: 'red'
                }
            };
            var trace3 = {
                type: 'scatter',
                x: usMap,//usMap,
                y: irMap,//ratioMap,
                name: 'IR',
                visible: 'legendonly',
                line: {
                  color: 'limegreen'
                }
            };
            var trace4 = {
                type: 'scatter',
                x: usMap,//usMap,
                y: ambientMap,//ratioMap,
                name: 'ambient',
                visible: 'legendonly'
            };
            var trace5 = {
                type: 'scatter',
                x: usMap,//usMap,
                y: velMap,//ratioMap,
                name: 'velocity',
                visible: 'legendonly'
            };
            var trace6 = {
                type: 'scatter',
                x: usMap,//usMap,
                y: accelMap,//ratioMap,
                name: 'acceleration',
                visible: 'legendonly'
            };
            var trace7 = {
              type: 'scatter',
              x: usMap,
              y: smaMap,
              name: 'Ratio SMA',
            }
            if(updatePlot == true){
              trace1.name = "Ratio 2";
              trace2.name = "Red 2";
              trace2.line = {
                  color: 'firebrick'
                }
              trace3.name = "IR 2";
              trace3.line = {
                  color: 'forestgreen'
                }
              trace4.name = "ambient 2"
              trace5.name = "vel. 2"
              trace6.name = "accel. 2"
              trace7.name = "Ratio SMA 2"
            }
            var data = [trace1,trace7,trace2,trace3,trace4,trace5,trace6];
            var layout = {
                title: { 
                  text: chartId.replace("_chart"," Session Chart"),
                },
                font: {
                  family: 'Courier New, Courier, monospace',
                  color: 'black'
                },
                plot_bgcolor: '#white',
                paper_bgcolor: '#white',
                xaxis: {
                  title: {
                    text: 'Time (min)'
                  },
                  gridcolor: '#ghostwhite',
                  tickcolor: '#1a1a1a',
                  zerolinecolor: '#1a1a1a'
                },
                yaxis: {
                  gridcolor: '#ghostwhite',
                  tickcolor: '#1a1a1a',
                  zerolinecolor: '#1a1a1a'
                },
                showlegend: true,
                margin: {
                  l: 40,
                  r: 10,
                  b: 40,
                  t: 85,
                  pad: 4
                }
            };

            var icon1 = {
                'width': 500,
                'height': 600,
                'path': 'M224 512c35.32 0 63.97-28.65 63.97-64H160.03c0 35.35 28.65 64 63.97 64zm215.39-149.71c-19.32-20.76-55.47-51.99-55.47-154.29 0-77.7-54.48-139.9-127.94-155.16V32c0-17.67-14.32-32-31.98-32s-31.98 14.33-31.98 32v20.84C118.56 68.1 64.08 130.3 64.08 208c0 102.3-36.15 133.53-55.47 154.29-6 6.45-8.66 14.16-8.61 21.71.11 16.4 12.98 32 32.1 32h383.8c19.12 0 32-15.6 32.1-32 .05-7.55-2.61-15.27-8.61-21.71z'
            }

            var config = { 
                scrollZoom: true, 
                responsive: true, 
                displaylogo: false,
                showEditInChartStudio: true,
                modeBarButtonsToAdd: [
                  {
                    name: 'Delete',
                    icon: icon1,
                    click: function(gd) {
                      document.getElementById(chartId).style.opacity = 0.0;
                      document.getElementById(chartId+"_keys").style.opacity = 0.0;
                      setTimeout(function() {
                        Plotly.purge(document.getElementById(chartId));
                        document.getElementById(chartId+"_keys").remove();
                        document.getElementById('fileinput').value = '';
                      }, 800);
                    }
                  }
                ]
            };

            function sessionAnalytics() { // Use this to set up a data display table for each chart.
              var sessionTime = usMap[usMap.length - 1];
              var sessionSec = Math.floor((sessionTime*60-(Math.floor(sessionTime)*60)));
              if(sessionSec < 10) { sessionSec = "0"+sessionSec}
              
              var ratioMean = ratioMap.reduce((previous,current) => current += previous) / ratioMap.length;
              var ratioBaseline = ratioMap.slice(0,200); // Use first n samples for baseline.
              ratioBaseline = ratioBaseline.reduce((previous,current) => current += previous) / ratioBaseline.length;
              
              var sessionGain = ratioMean / ratioBaseline;
              var gainColor = 'red';
              if(sessionGain >= 1){gainColor = 'green'}

              var sma_ratioError = 0;
              var sma_ratioMSE = 0;
              smaMap.forEach((item, idx) => {
                sma_ratioError += Math.abs((ratioMap[idx] - item) / item);
                sma_ratioMSE += Math.pow(ratioMap[idx] - item, 2); 
              }); // Math.abs(ratio - sma) / sma;
              sma_ratioError = sma_ratioError / smaMap.length; // Mean Relative Error
              sma_ratioRMSE = Math.sqrt(sma_ratioMSE / smaMap.length); //Root Mean Square Error
              
              var errCat = "♥ ฅ(=^ᆽ^=ฅ)";
              
              var errColor = 'black';
              if(sma_ratioError >= 0.20) {{errColor = 'red'; errCat = "(=XᆽX=)";}}
              else if(sma_ratioError >= 0.10) {errColor = 'orange'; errCat = "(=ʘᆽʘ=)?";}

              var tableHTML = "<table>"
              tableHTML += "<tr><td>Session Time:<br>"+sessionTime.toFixed(0)+":"+sessionSec+"</td><td>Baseline Ratio:<br>"+ratioBaseline.toFixed(3)+"</td><td>Average Ratio:<br>"+ratioMean.toFixed(3)+"</td><td style='color: "+gainColor+";'>Session Gain:<br>"+(sessionGain*100-100).toFixed(2)+"%</td></tr> \
               <tr><td style='color:"+errColor+";'>Ratio-SMA Error:<br>"+(sma_ratioError*100).toFixed(2)+"%</td><td style='color:"+errColor+";'>Ratio-SMA RMSE:<br>"+(sma_ratioRMSE).toFixed(4)+"</td><td>"+errCat+"</td><td><label id='"+chartId+"_compare' class='compare'>Compare Data</label></td></tr> \
               </table><hr>"; 
              document.getElementById(chartId+"_keys").innerHTML = tableHTML;
              
              var fragment = document.createDocumentFragment();
              var inputElem = document.createElement("input");
              inputElem.type = "file";
              inputElem.setAttribute("id",chartId+"_fileinput")
              inputElem.setAttribute("accept", ".csv");
              fragment.appendChild(inputElem)
              document.getElementById(chartId+"_compare").appendChild(fragment);
              document.getElementById(chartId+"_fileinput").onchange = function(event) {
                var file = event.target.files[0];
                if (file) {
                  //parent.postMessage(file,'*'); // Post file
                  var reader = new FileReader();
                    reader.onloadend = function(evt) {
                      var dataUrl = evt.target.result;
                      // The following call results in an "Access denied" error in IE.
                      drawChart(dataUrl, chartId, true, data);
                    };
                  reader.readAsDataURL(file);
                }
              }
              
            
            }

            if(updatePlot == false){
              Plotly.newPlot(chartId, data, layout, config);
              sessionAnalytics();
              document.getElementById(chartId).style.opacity = 1;
              document.getElementById(chartId+"_keys").style.opacity = 1;
            }
            else {
              data = [...olddata,...data];
              Plotly.react(chartId, data, layout);
            }
            
          });
       }

       d3.select("html")
          .style("height","100%")

       d3.select("#filelabel")
      
        .append("input")
          .attr("type", "file")
          .attr("id","fileinput")
          .attr("accept", ".csv")
          .on("change", function() {
            var file = d3.event.target.files[0];
            if (file) {
              parent.postMessage(file,'*'); // Post file
              var reader = new FileReader();
                reader.onloadend = function(evt) {
                  var dataUrl = evt.target.result;
                  var chartId = file.name+"_chart"
                  d3.select("#chartContainer")
                    .append("div")
                        .attr("id", chartId)
                        .style("margin", "5px")
                        .style("opacity", "0.0")
                    
                  d3.select("#chartContainer")
                    .append("div")
                        .attr("id", chartId+"_keys")
                        .style("margin", "5px")
                        .style("opacity", "0.0")
                  // The following call results in an "Access denied" error in IE.
                  drawChart(dataUrl, chartId, false);
                };
               reader.readAsDataURL(file);
              }
            })

        window.addEventListener("message", receiveMessage, false);
        
        function receiveMessage(event) {
            console.log("message: ", event.data)
            var file = new File([""],event.data);
            console.log(file);
            var reader = new FileReader();
            reader.readAsText(file); //event.data); for chart.js event
            reader.onload = event => {
                console.log("File Contents: ", event.target.result);
                //document.getElementById("preview").innerHTML = event.target.result;
            }
        }

        function sma(arr, window) {
          var temp = [];
          for(i = 0; i < arr.length; i++) {
            if((i == 0)) {
              temp.push(arr[0]);
            }
            else if(i < window) {
              var arrslice = arr.slice(0,i+1);
              temp.push(arrslice.reduce((previous,current) => current += previous ) / (i+1));
            }
            else {
              var arrslice = arr.slice(i-window,i);
              temp.push(arrslice.reduce((previous,current) => current += previous) / window);
            }
          }
          //console.log(temp);
          return temp;
        }
</script>
</body>
</html>